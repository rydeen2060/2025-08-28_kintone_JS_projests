# 前回の逸脱判定コピー機能

## 概要
kintoneアプリで、レコード保存時に前回のレコードの逸脱判定を自動的にコピーする機能です。

## 機能説明

### 主な処理
1. レコードの新規作成または編集時に自動実行
2. 現在のレコードの測定日時より前の最新レコードを検索
3. 前回のレコードの逸脱判定を取得し、`prev_deviation`フィールドに自動設定

### 対応イベント
- レコード新規作成時（`app.record.create.submit`）
- レコード編集時（`app.record.edit.submit`）

## フィールド定義

| フィールドコード | 説明 | 備考 |
|---|---|---|
| `datetime_001` | 測定日時 | レコードの時系列順を判定するために使用 |
| `deviation_status` | 現在の逸脱判定 | ユーザーが入力または自動判定される値 |
| `prev_deviation` | 前回の逸脱判定 | 本スクリプトで自動設定される |

## 処理フロー

```
1. レコード保存イベント発火
   ↓
2. 現在のレコードの測定日時とIDを取得
   ↓
3. kintone REST APIで検索
   - 条件: 現在の日時より前
   - 条件: 自分自身を除外（編集時）
   - ソート: 測定日時の降順
   - 件数: 1件のみ
   ↓
4. 取得した前回レコードの逸脱判定を設定
   ↓
5. レコード保存完了
```

## 使用例

時系列でデータが蓄積される場合の動作例：

```
レコード1:
  datetime_001: "2025-12-01 10:00"
  deviation_status: "正常"
  prev_deviation: ""（前回データなし）

レコード2:
  datetime_001: "2025-12-01 11:00"
  deviation_status: "警告"
  prev_deviation: "正常"（自動設定）

レコード3:
  datetime_001: "2025-12-01 12:00"
  deviation_status: "異常"
  prev_deviation: "警告"（自動設定）
```

## エラーハンドリング
- API取得エラーが発生した場合でも、レコード保存は継続されます
- エラー時は`prev_deviation`フィールドに空文字が設定されます
- エラー内容はコンソールに出力されます

## セットアップ

1. kintoneアプリに以下のフィールドを作成：
   - `datetime_001`（日時フィールド）
   - `deviation_status`（文字列フィールドまたはドロップダウン）
   - `prev_deviation`（文字列フィールド、読み取り専用推奨）

2. JavaScriptファイルをkintoneアプリに設定：
   - アプリの設定 → JavaScript / CSSでカスタマイズ
   - `2025-12-06_alert_controller.js`をアップロード

3. アプリを更新して動作確認

## 注意事項
- `prev_deviation`フィールドは自動設定されるため、ユーザーが直接編集する必要はありません
- 測定日時が未入力の場合、前回レコードの検索が正しく機能しない可能性があります
- kintone REST APIの実行権限が必要です

## ファイル
- `2025-12-06_alert_controller.js` - メインスクリプト

## 作成日
2025-12-06
